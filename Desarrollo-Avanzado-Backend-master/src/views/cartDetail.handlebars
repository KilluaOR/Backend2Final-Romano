<div class="d-flex align-items-center justify-content-between mb-3">
  <h1 class="mb-0">Detalle del carrito</h1>
  <div class="d-flex gap-2">
    <button class="btn btn-outline-danger" id="empty-cart-btn" type="button">Vaciar carrito</button>
    <a href="/products" class="btn btn-outline-secondary">← Volver a productos</a>
  </div>
</div>

{{#if products.length}}
  <div class="row g-3">
    {{#each products}}
      <div class="col-12">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start gap-3">
              <div>
                <h5 class="card-title mb-1">{{this.product.title}}</h5>
                <p class="mb-0 text-muted">Precio unitario: ${{this.product.price}}</p>
                <p class="mb-0">Cantidad: <strong>{{this.quantity}}</strong></p>
              </div>
              <div class="text-end">
                <div class="fw-bold">Total</div>
                <div class="fs-5">${{multiply this.product.price this.quantity}}</div>
                <button
                  class="btn btn-sm btn-outline-danger mt-2"
                  type="button"
                  onclick="removeFromCart('{{../cid}}','{{this.product._id}}')"
                >
                  Eliminar
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    {{/each}}
  </div>

  <div class="card mt-4">
    <div class="card-body d-flex justify-content-between align-items-center">
      <div class="fw-bold">Total del carrito</div>
      <div class="fs-4">$ {{cartTotal products}}</div>
    </div>
  </div>
{{else}}
  <div class="alert alert-info">El carrito está vacío.</div>
{{/if}}

<script>
  async function removeFromCart(cid, pid) {
    if (!cid || !pid) return;
    if (!confirm('¿Eliminar este producto del carrito?')) return;

    const res = await fetch(`/api/carts/${cid}/product/${pid}`, { method: 'DELETE' });
    const data = await res.json().catch(() => ({}));

    if (!res.ok || data.status === 'error') {
      alert(data.message || 'No se pudo eliminar el producto');
      return;
    }

    window.location.reload();
  }

  document.addEventListener('DOMContentLoaded', () => {
    const emptyBtn = document.getElementById('empty-cart-btn');
    if (!emptyBtn) return;

    emptyBtn.addEventListener('click', async () => {
      const cid = '{{cid}}';
      if (!cid) return;
      if (!confirm('¿Vaciar el carrito completo?')) return;

      const res = await fetch(`/api/carts/${cid}`, { method: 'DELETE' });
      const data = await res.json().catch(() => ({}));

      if (!res.ok || data.status === 'error') {
        alert(data.message || 'No se pudo vaciar el carrito');
        return;
      }

      window.location.reload();
    });
  });
</script>

